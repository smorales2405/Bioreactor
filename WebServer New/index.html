<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biorreactor - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistema de Control - Biorreactor</h1>
            <div class="connection-status">
                <span class="status-indicator" id="status"></span>
                <span>Estado: <span id="statusText">Conectando...</span></span>
            </div>
        </header>

        <nav class="main-nav">
            <button class="nav-btn active" onclick="showSection('sensors')">
                üå°Ô∏è Sensores
            </button>
            <button class="nav-btn" onclick="showSection('leds')">
                üí° Control LED
            </button>
            <button class="nav-btn" onclick="showSection('aireacion')">
                üí® Aireaci√≥n
            </button>
            <button class="nav-btn" onclick="showSection('llenado')">
                üíß Llenado
            </button>
        </nav>

        <!-- Secci√≥n Sensores -->
        <section id="sensors" class="section active">
            <h2>Monitoreo de Sensores</h2>
            
            <div class="sensors-grid">
                <!-- Temperatura (modificar en la secci√≥n de sensores) -->
                <div class="sensor-card">
                    <h3>Temperatura</h3>
                    <div class="sensor-value">
                        <span id="tempValue">--</span>
                        <span class="unit">¬∞C</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge" id="tempGauge">
                            <div class="gauge-fill"></div>
                            <div class="gauge-label">0¬∞C - 50¬∞C</div>
                        </div>
                    </div>
                    <div class="temp-limits">
                        <button class="btn btn-secondary btn-small" onclick="showTempLimits()">Fijar L√≠mites</button>
                        <div class="limits-display">
                            <span class="limit-min">Min: <span id="tempLimitMin">--</span>¬∞C</span>
                            <span class="limit-max">Max: <span id="tempLimitMax">--</span>¬∞C</span>
                        </div>
                    </div>
                </div>

                <!-- pH -->
                <div class="sensor-card clickable" onclick="showPhControl()">
                    <h3>pH</h3>
                    <div class="sensor-value">
                        <span id="phValue">--</span>
                    </div>
                    <div class="ph-indicator" id="phIndicator">
                        <div class="ph-scale">
                            <div class="ph-marker" id="phMarker"></div>
                        </div>
                        <div class="ph-labels">
                            <span class="acid">√Åcido</span>
                            <span class="neutral">Neutro</span>
                            <span class="base">Base</span>
                        </div>
                    </div>
                    <div class="click-hint">Click para control de pH</div>
                </div>

                <!-- Concentraci√≥n -->
                <div class="sensor-card">
                    <h3>Concentraci√≥n</h3>
                    <div class="sensor-value">
                        <span id="concValue">--</span>
                        <span class="unit">MC/mL</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge" id="concGauge">
                            <div class="gauge-fill"></div>
                            <div class="gauge-label">0 - 40 MC/mL</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos hist√≥ricos -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Hist√≥rico de Temperatura</h3>
                    <canvas id="tempChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Hist√≥rico de pH</h3>
                    <canvas id="phChart"></canvas>
                </div>
            </div>

            <div id="alarmPanel" class="alarm-panel" style="display:none;">
                <div class="alarm-content">
                    <div class="alarm-header">
                        <h3>‚ö†Ô∏è ALARMA ACTIVA</h3>
                        <button class="btn-close" onclick="silenceAlarm()">Silenciar</button>
                    </div>
                    <div class="alarm-reasons" id="alarmReasons">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>

        </section>

        <!-- Secci√≥n Control LED -->
        <section id="leds" class="section">
            <h2>Control de Iluminaci√≥n LED</h2>
            
            <div class="led-tabs">
                <button class="tab-btn active" onclick="showLedTab('manual')">Control Manual</button>
                <button class="tab-btn" onclick="showLedTab('sequences')">Secuencias</button>
            </div>

            <!-- Control Manual -->
            <div id="manual" class="led-content active">
                <div class="master-controls">
                    <button class="btn btn-primary" onclick="allLedsOn()">Encender Todos</button>
                    <button class="btn btn-secondary" onclick="allLedsOff()">Apagar Todos</button>
                </div>

                <div class="led-controls-grid">
                    <!-- LED Blanco -->
                    <div class="led-control-card">
                        <h3>Blanco</h3>
                        <div class="led-indicator white" id="whiteLed"></div>
                        <div class="intensity-display">
                            <span>Intensidad <br>
                            <span id="whiteIntensity">0</span>%
                        </div>
                        <input type="range" class="slider" id="whiteSlider" min="0" max="100" value="0" 
                               oninput="updateLed('white', this.value)">
                        <div class="led-buttons">
                            <button class="btn btn-on" onclick="setLed('white', 100)">ON</button>
                            <button class="btn btn-off" onclick="setLed('white', 0)">OFF</button>
                        </div>
                    </div>

                    <!-- LED Rojo -->
                    <div class="led-control-card">
                        <h3>Rojo</h3>
                        <div class="led-indicator red" id="redLed"></div>
                        <div class="intensity-display">
                            <span>Intensidad <br>
                            <span id="redIntensity">0</span>%
                        </div>
                        <input type="range" class="slider" id="redSlider" min="0" max="100" value="0"
                               oninput="updateLed('red', this.value)">
                        <div class="led-buttons">
                            <button class="btn btn-on" onclick="setLed('red', 100)">ON</button>
                            <button class="btn btn-off" onclick="setLed('red', 0)">OFF</button>
                        </div>
                    </div>

                    <!-- LED Verde -->
                    <div class="led-control-card">
                        <h3>Verde</h3>
                        <div class="led-indicator green" id="greenLed"></div>
                        <div class="intensity-display">
                            <span>Intensidad <br>
                            <span id="greenIntensity">0</span>%
                        </div>
                        <input type="range" class="slider" id="greenSlider" min="0" max="100" value="0"
                               oninput="updateLed('green', this.value)">
                        <div class="led-buttons">
                            <button class="btn btn-on" onclick="setLed('green', 100)">ON</button>
                            <button class="btn btn-off" onclick="setLed('green', 0)">OFF</button>
                        </div>
                    </div>

                    <!-- LED Azul -->
                    <div class="led-control-card">
                        <h3>Azul</h3>
                        <div class="led-indicator blue" id="blueLed"></div>
                        <div class="intensity-display">
                            <span>Intensidad <br>
                            <span id="blueIntensity">0</span>%
                        </div>
                        <input type="range" class="slider" id="blueSlider" min="0" max="100" value="0"
                               oninput="updateLed('blue', this.value)">
                        <div class="led-buttons">
                            <button class="btn btn-on" onclick="setLed('blue', 100)">ON</button>
                            <button class="btn btn-off" onclick="setLed('blue', 0)">OFF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secuencias -->
            <div id="sequences" class="led-content">
                <div class="sequence-status" id="sequenceStatus">
                    <p>Estado: <span id="seqStatusText">Inactivo</span></p>
                    <button class="btn btn-danger" id="stopSeqBtn" onclick="stopSequence()" style="display:none;">
                        Detener Secuencia
                    </button>
                </div>

                <div class="sequences-grid" id="sequencesList">
                    <!-- Las secuencias se cargar√°n din√°micamente -->
                </div>
            </div>
        </section>

        <!-- Secci√≥n Control de pH -->
        <section id="phControl" class="section">
            <button class="btn-back" onclick="showSection('sensors')">‚Üê Volver a Sensores</button>
            <h2>Control de pH</h2>
            
            <div class="ph-control-container">
                <!-- Panel Principal de pH -->
                <div class="ph-main-panel">
                    <div class="ph-display">
                        <div class="ph-current">
                            <span class="ph-label">pH Actual</span>
                            <div class="ph-value-large" id="phCurrentLarge">7.5</div>
                        </div>
                        <div class="ph-status-indicator" id="phStatusIndicator">
                            <div class="ph-status-bar"></div>
                            <div class="ph-status-text" id="phStatusText">EQUILIBRADO</div>
                        </div>
                    </div>
                    
                    <div class="ph-fixed-display">
                        <span class="ph-fixed-label">pH FIJADO</span>
                        <div class="ph-fixed-value" id="phFixedValue">7.0</div>
                    </div>
                </div>
                
                <!-- Controles -->
                <div class="ph-controls">
                    <!-- Control Autom√°tico -->
                    <div class="control-panel">
                        <h3>Control Autom√°tico</h3>
                        <div class="ph-auto-control">
                            <label>Fijar pH L√≠mite:</label>
                            <div class="ph-input-group">
                                <button class="btn-adjust" onclick="adjustPhLimit(-0.1)">‚àí</button>
                                <input type="number" id="phLimitInput" min="0" max="14" step="0.1" value="7.0">
                                <button class="btn-adjust" onclick="adjustPhLimit(0.1)">+</button>
                            </div>
                            <button class="btn btn-primary" onclick="setPhAutoControl()">Activar Control Auto</button>
                            <button class="btn btn-secondary" onclick="stopPhAutoControl()">Desactivar</button>
                        </div>
                        
                        <div class="auto-status">
                            <p>Estado: <span id="autoControlStatus">INACTIVO</span></p>
                            <div class="co2-auto-indicator" id="co2AutoIndicator">
                                <span>CO2 Auto:</span>
                                <div class="indicator-light" id="co2AutoLight"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inyecci√≥n Manual -->
                    <div class="control-panel">
                        <h3>Inyecci√≥n Manual CO2</h3>
                        
                        <!-- Configuraci√≥n de tiempo -->
                        <div class="time-config">
                            <label>Tiempo de Inyecci√≥n:</label>
                            <div class="time-input-group">
                                <div class="time-control">
                                    <label>Minutos</label>
                                    <div class="input-group">
                                        <button class="btn-adjust" onclick="adjustCO2Time('minutes', -1)">‚àí</button>
                                        <input type="number" id="co2Minutes" min="0" max="59" value="0">
                                        <button class="btn-adjust" onclick="adjustCO2Time('minutes', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modo programado -->
                        <div class="programmed-mode">
                            <label>
                                <input type="checkbox" id="co2LoopMode">
                                Modo Bucle (Repetir autom√°ticamente)
                            </label>
                            <div id="loopConfig" style="display:none;">
                                <label>Repetir cada (horas):</label>
                                <input type="number" id="loopInterval" min="1" max="24" value="4">
                            </div>
                        </div>
                        
                        <!-- Controles de ejecuci√≥n -->
                        <div class="execution-controls">
                            <button class="btn btn-success" onclick="startCO2Injection()">INICIAR</button>
                            <button class="btn btn-warning" onclick="pauseCO2Injection()">DETENER</button>
                            <button class="btn btn-danger" onclick="resetCO2Injection()">REINICIAR</button>
                        </div>
                        
                        <!-- Display de tiempo restante -->
                        <div class="co2-timer" id="co2Timer">
                            <div class="timer-display" id="timerDisplay">
                                <span class="timer-label">CO2 Restante</span>
                                <div class="timer-value" id="co2TimeRemaining">00:00</div>
                            </div>
                            <div class="timer-progress">
                                <div class="timer-fill" id="timerFill"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Aireaci√≥n -->
        <section id="aireacion" class="section">
            <h2>Control de Ingreso de Aire y CO2</h2>
            
            <div class="aireacion-grid">
                <!-- Control de Aireaci√≥n -->
                <div class="control-card">
                    <h3>Aireaci√≥n</h3>
                    <div class="status-indicator-large" id="aireacionIndicator">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </div>
                    <div class="status-text" id="aireacionStatus">APAGADO</div>
                    <div class="control-buttons">
                        <button class="btn btn-on" onclick="controlAireacion(true)">Encender</button>
                        <button class="btn btn-off" onclick="controlAireacion(false)">Apagar</button>
                    </div>
                </div>
                
                <!-- Control de CO2 -->
                <div class="control-card">
                    <h3>Inyecci√≥n CO2</h3>
                    <div class="status-indicator-large" id="co2Indicator">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </div>
                    <div class="status-text" id="co2Status">APAGADO</div>
                    <div class="control-buttons">
                        <button class="btn btn-on" onclick="controlCO2(true)">Encender</button>
                        <button class="btn btn-off" onclick="controlCO2(false)">Apagar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Llenado -->
        <section id="llenado" class="section">
            <h2>Control de Llenado de Agua</h2>
            
            <div class="llenado-container">
                <!-- Display de volumen -->
                <div class="volume-display">
                    <h3>Volumen Actual</h3>
                    <div class="volume-value">
                        <span id="currentVolume">0.0</span>
                        <span class="unit">L</span>
                    </div>
                    <div class="volume-gauge">
                        <div class="volume-fill" id="volumeFill"></div>
                        <div class="volume-scale">0 - 200 L</div>
                    </div>
                </div>
                
                <!-- Control de llenado -->
                <div class="filling-control">
                    <h3>Control de Llenado</h3>
                    
                    <!-- Estado de llenado -->
                    <div class="filling-status" id="fillingStatus">
                        <p>Estado: <span id="fillingStatusText">Inactivo</span></p>
                        <div id="fillingProgress" style="display:none;">
                            <p>Llenado: <span id="fillingVolume">0.0</span> / <span id="targetVolume">0.0</span> L</p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Control autom√°tico -->
                    <div class="auto-fill">
                        <h4>Llenado Autom√°tico</h4>
                        <div class="volume-input">
                            <label>Volumen de Ingreso deseado (L):</label>
                            <input type="number" id="volumeInput" min="0" max="200" step="5" value="0">
                            <input type="range" id="volumeSlider" min="0" max="200" step="5" value="0">
                        </div>
                        <div class="auto-fill-buttons">
                            <button class="btn btn-primary" id="startFillBtn" onclick="startAutoFill()">Iniciar Llenado</button>
                            <button class="btn btn-danger" id="stopFillBtn" onclick="stopFilling()">Detener Llenado</button>
                        </div>
                    </div>
                    
                    <!-- Control manual -->
                    <div class="manual-control">
                        <h4>Control Manual de Bomba</h4>
                        <div class="pump-status">
                            <div class="pump-indicator" id="pumpIndicator"></div>
                            <span id="pumpStatus">Bomba APAGADA</span>
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-on" onclick="controlPump(true)">Encender Bomba</button>
                            <button class="btn btn-off" onclick="controlPump(false)">Apagar Bomba</button>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n de reinicio -->
                    <div class="reset-section">
                        <button class="btn btn-secondary" onclick="resetVolume()">Reiniciar Volumen</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal para configurar secuencia -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Configurar Secuencia <span id="seqNumber"></span></h2>
            
            <div class="seq-config">
                <label>N√∫mero de pasos:</label>
                <input type="number" id="stepCount" min="1" max="10" value="1" onchange="updateStepsConfig()">
                
                <div id="stepsContainer">
                    <!-- Los pasos se generar√°n din√°micamente -->
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="saveSequence()">Guardar</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tempLimitsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTempLimitsModal()">&times;</span>
            <h2>Configurar L√≠mites de Temperatura</h2>
            
            <div class="limits-config">
                <div class="limit-group">
                    <label>L√≠mite M√≠nimo (¬∞C):</label>
                    <div class="input-group">
                        <button class="btn-adjust" onclick="adjustTempLimit('min', -0.5)">‚àí</button>
                        <input type="number" id="tempMinInput" min="10" max="30" step="0.5" value="18">
                        <button class="btn-adjust" onclick="adjustTempLimit('min', 0.5)">+</button>
                    </div>
                    <input type="range" id="tempMinSlider" min="10" max="30" step="0.5" value="18">
                </div>
                
                <div class="limit-group">
                    <label>L√≠mite M√°ximo (¬∞C):</label>
                    <div class="input-group">
                        <button class="btn-adjust" onclick="adjustTempLimit('max', -0.5)">‚àí</button>
                        <input type="number" id="tempMaxInput" min="10" max="30" step="0.5" value="28">
                        <button class="btn-adjust" onclick="adjustTempLimit('max', 0.5)">+</button>
                    </div>
                    <input type="range" id="tempMaxSlider" min="10" max="30" step="0.5" value="28">
                </div>
                
                <div class="limits-preview">
                    <div class="preview-bar">
                        <div class="preview-range" id="tempRangePreview"></div>
                        <div class="preview-min" id="previewMin"></div>
                        <div class="preview-max" id="previewMax"></div>
                    </div>
                    <div class="preview-labels">
                        <span>10¬∞C</span>
                        <span>20¬∞C</span>
                        <span>30¬∞C</span>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="saveTempLimits()">Guardar</button>
                    <button class="btn btn-secondary" onclick="closeTempLimitsModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>